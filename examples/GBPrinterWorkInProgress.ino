/* This is based on the works of Miles Burton and the furrtek gang/guy.
 * I made this a library for easier integration into sketches
 * TODO: 
 * TextToPrint ( thats what the alphabet array is for)
 * 
 * 
 * Byte1 0x0101 0101
 * Byte2 0x0011 0011
 * color   0123 0123
 * 
 * http://www.milesburton.com/Gameboy_Printer_with_Arduino
 */
 
#include <GBPrinter.h>

//uint8_t c,b,cmd,repl,buffer[64];
uint8_t cmd;
uint16_t CRC;

uint8_t row[640] = { // 16 * 40 each row is a tile row
  0xFA,0xF8,0x82,0x80,0x82,0x80,0xE2,0xE0,0x82,0x80,0x82,0x80,0x81,0x80,0x00,0x00, // FU
  0x20,0x07,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x60,0x08,0xA0,0x07,0x00,0x00, // UC
  0x22,0x02,0xA4,0x04,0x28,0x08,0x30,0x00,0x28,0x08,0xA4,0x04,0x22,0x02,0x00,0x00, // CK
  0xA0,0x88,0xA0,0x88,0xA0,0x88,0xA0,0x88,0xA0,0x88,0x00,0x00,0xA0,0x88,0x00,0x00, // !!!
  0xFA,0xF8,0x82,0x80,0x82,0x80,0xE2,0xE0,0x82,0x80,0x82,0x80,0x81,0x80,0x00,0x00, // FU
  0x20,0x07,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x60,0x08,0xA0,0x07,0x00,0x00, // UC
  0x22,0x02,0xA4,0x04,0x28,0x08,0x30,0x00,0x28,0x08,0xA4,0x04,0x22,0x02,0x00,0x00, // CK
  0xA0,0x88,0xA0,0x88,0xA0,0x88,0xA0,0x88,0xA0,0x88,0x00,0x00,0xA0,0x88,0x00,0x00, // !!!
  0xFA,0xF8,0x82,0x80,0x82,0x80,0xE2,0xE0,0x82,0x80,0x82,0x80,0x81,0x80,0x00,0x00, // FU
  0x20,0x07,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x60,0x08,0xA0,0x07,0x00,0x00, // UC
  0x22,0x02,0xA4,0x04,0x28,0x08,0x30,0x00,0x28,0x08,0xA4,0x04,0x22,0x02,0x00,0x00, // CK
  0xA0,0x88,0xA0,0x88,0xA0,0x88,0xA0,0x88,0xA0,0x88,0x00,0x00,0xA0,0x88,0x00,0x00, // !!!
  0xFA,0xF8,0x82,0x80,0x82,0x80,0xE2,0xE0,0x82,0x80,0x82,0x80,0x81,0x80,0x00,0x00, // FU
  0x20,0x07,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x60,0x08,0xA0,0x07,0x00,0x00, // UC
  0x22,0x02,0xA4,0x04,0x28,0x08,0x30,0x00,0x28,0x08,0xA4,0x04,0x22,0x02,0x00,0x00, // CK
  0xA0,0x88,0xA0,0x88,0xA0,0x88,0xA0,0x88,0xA0,0x88,0x00,0x00,0xA0,0x88,0x00,0x00, // !!!
  0xFA,0xF8,0x82,0x80,0x82,0x80,0xE2,0xE0,0x82,0x80,0x82,0x80,0x81,0x80,0x00,0x00, // FU
  0x20,0x07,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x60,0x08,0xA0,0x07,0x00,0x00, // UC
  0x22,0x02,0xA4,0x04,0x28,0x08,0x30,0x00,0x28,0x08,0xA4,0x04,0x22,0x02,0x00,0x00, // CK
  0xA0,0x88,0xA0,0x88,0xA0,0x88,0xA0,0x88,0xA0,0x88,0x00,0x00,0xA0,0x88,0x00,0x00, // !!!
  0xFA,0xF8,0x82,0x80,0x82,0x80,0xE2,0xE0,0x82,0x80,0x82,0x80,0x81,0x80,0x00,0x00, // FU
  0x20,0x07,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x60,0x08,0xA0,0x07,0x00,0x00, // UC
  0x22,0x02,0xA4,0x04,0x28,0x08,0x30,0x00,0x28,0x08,0xA4,0x04,0x22,0x02,0x00,0x00, // CK
  0xA0,0x88,0xA0,0x88,0xA0,0x88,0xA0,0x88,0xA0,0x88,0x00,0x00,0xA0,0x88,0x00,0x00, // !!!
  0xFA,0xF8,0x82,0x80,0x82,0x80,0xE2,0xE0,0x82,0x80,0x82,0x80,0x81,0x80,0x00,0x00, // FU
  0x20,0x07,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x60,0x08,0xA0,0x07,0x00,0x00, // UC
  0x22,0x02,0xA4,0x04,0x28,0x08,0x30,0x00,0x28,0x08,0xA4,0x04,0x22,0x02,0x00,0x00, // CK
  0xA0,0x88,0xA0,0x88,0xA0,0x88,0xA0,0x88,0xA0,0x88,0x00,0x00,0xA0,0x88,0x00,0x00, // !!!
  0xFA,0xF8,0x82,0x80,0x82,0x80,0xE2,0xE0,0x82,0x80,0x82,0x80,0x81,0x80,0x00,0x00, // FU
  0x20,0x07,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x60,0x08,0xA0,0x07,0x00,0x00, // UC
  0x22,0x02,0xA4,0x04,0x28,0x08,0x30,0x00,0x28,0x08,0xA4,0x04,0x22,0x02,0x00,0x00, // CK
  0xA0,0x88,0xA0,0x88,0xA0,0x88,0xA0,0x88,0xA0,0x88,0x00,0x00,0xA0,0x88,0x00,0x00, // !!!
  0xFA,0xF8,0x82,0x80,0x82,0x80,0xE2,0xE0,0x82,0x80,0x82,0x80,0x81,0x80,0x00,0x00, // FU
  0x20,0x07,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x60,0x08,0xA0,0x07,0x00,0x00, // UC
  0x22,0x02,0xA4,0x04,0x28,0x08,0x30,0x00,0x28,0x08,0xA4,0x04,0x22,0x02,0x00,0x00, // CK
  0xA0,0x88,0xA0,0x88,0xA0,0x88,0xA0,0x88,0xA0,0x88,0x00,0x00,0xA0,0x88,0x00,0x00, // !!!
  0xFA,0xF8,0x82,0x80,0x82,0x80,0xE2,0xE0,0x82,0x80,0x82,0x80,0x81,0x80,0x00,0x00, // FU
  0x20,0x07,0x20,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x60,0x08,0xA0,0x07,0x00,0x00, // UC
  0x22,0x02,0xA4,0x04,0x28,0x08,0x30,0x00,0x28,0x08,0xA4,0x04,0x22,0x02,0x00,0x00, // CK
  0xA0,0x88,0xA0,0x88,0xA0,0x88,0xA0,0x88,0xA0,0x88,0x00,0x00,0xA0,0x88,0x00,0x00 // !!!
};

uint8_t alphabet[130] = {
  0x00111111, 0x01001000, 0x01001000, 0x01001000, 0x00111111, // A
  0x01111111, 0x01001001, 0x01001001, 0x01001001, 0x00110110, // B
  0x00111110, 0x01000001, 0x01000001, 0x01000001, 0x00100010, // C
  0x01111111, 0x01000001, 0x01000001, 0x01000001, 0x00111110, // D
  0x01111111, 0x01001001, 0x01001001, 0x01001001, 0x01000001, // E
  0x01111111, 0x01001000, 0x01001000, 0x01001000, 0x01000000, // F
  0x00111110, 0x01000001, 0x01000001, 0x01001001, 0x00101110, // G
  0x01111111, 0x00001000, 0x00001000, 0x00001000, 0x01111111, // H
  0x01000001, 0x01000001, 0x01111111, 0x01000001, 0x01000001, // I
  0x01000010, 0x01000001, 0x01000001, 0x01000001, 0x01111110, // J
  0x01111111, 0x00001000, 0x00010100, 0x00100010, 0x01000001, // K
  0x01111111, 0x00000001, 0x00000001, 0x00000001, 0x00000001, // L
  0x01111111, 0x00100000, 0x00010000, 0x00100000, 0x01111111, // M
  0x01111111, 0x00100000, 0x00010000, 0x00001000, 0x01111111, // N
  0x00111110, 0x01000001, 0x01000001, 0x01000001, 0x00111110, // O
  0x01111111, 0x01001000, 0x01001000, 0x01001000, 0x00110000, // P
  0x00111110, 0x01000001, 0x01000101, 0x01000011, 0x00111111, // Q
  0x01111111, 0x01001000, 0x01001100, 0x01001010, 0x00110001, // R
  0x00110010, 0x01001001, 0x01001001, 0x01001001, 0x00100110, // S
  0x01000000, 0x01000000, 0x01111111, 0x01000000, 0x01000000, // T
  0x01111110, 0x00000001, 0x00000001, 0x00000001, 0x01111110, // U
  0x01111100, 0x00000010, 0x00000001, 0x00000010, 0x01111100, // V
  0x01111111, 0x00000010, 0x00001100, 0x00000010, 0x01111111, // W
  0x01100011, 0x00010100, 0x00001000, 0x00010100, 0x01100011, // X
  0x01100000, 0x00010000, 0x00001111, 0x00010000, 0x01100000, // Y
  0x01000011, 0x01000101, 0x01001001, 0x01010001, 0x01100001  // Z
};


void setup() {
  setupPrinter(GBIn, GBOut, GBClock);
  Serial.begin(9600);
  Serial.println("Gameboy Printer for Arduino");
}

void loop() {
  //serialCommand = Serial.read();
  cmd = Serial.read();

  // connection Test
  if (cmd == '?') {

    if (sendInitialize()) {
      getStatusCode();
      Serial.print('1');
    } 
    else {
      Serial.print('0');
    }
  }

// Data Out flush row data set 4 times
  if(cmd == 'g') {
    Serial.println("Init");        
    sendInitialize();
    getStatusCode();

    for (int j=0; j<4; j++) {
      // each row is started like this
      sendRow(row);
      // and ends like this
    }
    
    Serial.println("Inq");        
    sendInquiry();
    
    Serial.println("Data"); 
    GBPCommand(GBData,0);
    printStatusCode(-1);
    Serial.println("Print");
    sendPrint(1,3,0xE4,0x40);
    printStatusCode(-1);
  }
}

void printText (String c) {
  uint8_t printRow[640];
  for (int i = 0; i<c.length(); i++) {
    if (c[i]>64 && c[i]<91) {
      // insert super code here    
    }
  }
  Serial.println("Init");        
  sendInitialize();
  getStatusCode();
  sendRow(printRow);
  Serial.println("Inq");
  sendInquiry();
  Serial.println("Data"); 
  GBPCommand(GBData,0);
  printStatusCode(-1);
  Serial.println("Print");
  sendPrint(1,3,0xE4,0x40);
  printStatusCode(-1);
}

void sendRow (uint8_t row2send[]) {
    CRC = 0;
    Serial.println("Data");
    CRC += beginData();
    for(int i=0; i<640; ++i) {
      uint8_t cmd = row2send[i];
      CRC += cmd;
      GBSerialOut(cmd);
    }

    if(endData(CRC)) //0x27E06
    { 
      Serial.println("Data sent");
    }
    printStatusCode(-1);
}
